<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>FROJAX FREE CLICK</title>
<link rel="icon" href="assets/Frojax-Logo2024.png">
<style>
  :root{ --bg:#0b0b0c; --card:#141417; --gold:#d4af37; --muted:#9a9aa0; --text:#f5f5f7; --panel:#1a1a20; --footer-h:56px; }
  *{ box-sizing:border-box; }
  html, body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; }
  /* Natural layout: no fixed heights, no inner scrollbars */
  .wrap{ max-width:860px; margin:0 auto; padding:12px; }
  .card{ background:var(--card); border:1px solid #22252a; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:12px 12px 0; }
  .header{ text-align:center; }
  h1{ margin:6px 0 8px; color:var(--gold); font-weight:900; letter-spacing:.5px; font-size:clamp(18px,3.5vw,28px); }
  .logo{ display:block; margin:6px auto 6px; max-height:90px; width:auto; object-fit:contain; filter:drop-shadow(0 0 6px rgba(0,0,0,.6)); }
  .title-text{ text-align:center; color:var(--gold); font-weight:900; letter-spacing:.5px; font-size:clamp(20px,3.5vw,30px); margin-bottom:8px; }
  /* Indicators */
  .indicatorRow{ display:flex; align-items:center; justify-content:center; gap:14px; flex-wrap:wrap; }
  .pulse{ width:clamp(90px,20vw,130px); height:clamp(90px,20vw,130px); border-radius:50%; border:4px solid var(--gold); display:grid; place-items:center; position:relative; overflow:hidden; margin:6px 0; }
  .pulseCore{ position:absolute; inset:10%; border-radius:50%; background:rgba(212,175,55,.08); }
  .pulseRing{ position:absolute; inset:0; border-radius:50%; border:0 solid var(--gold); opacity:0; }
  .pulse.glow{ box-shadow:0 0 36px rgba(212,175,55,.75), 0 0 90px rgba(212,175,55,.35) inset; }
  @keyframes pulseGlow{ 0%{ transform:scale(.9); opacity:.65; border-width:10px } 100%{ transform:scale(1.35); opacity:0; border-width:0 } }
  .ringAnim{ animation:pulseGlow 650ms ease-out; }
  .bpmBig{ display:flex; align-items:baseline; justify-content:center; gap:10px; flex-wrap:wrap; }
  .bpmValue{ font-size:clamp(56px,10vw,110px); font-weight:900; line-height:.9; text-align:center; }
  .bpmUnit,.tsInline{ font-size:clamp(13px,2.5vw,18px); font-weight:700; letter-spacing:.6px; }
  .tsInline{ color:var(--gold); }
  /* Controls */
  .controls{ display:grid; gap:12px; justify-items:center; text-align:center; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }
  label{ color:var(--muted); font-size:13px; }
  input[type="range"]{ width:min(520px,92%); }
  .select{ background:#111; border:1px solid #2a2a33; color:#fff; padding:8px 10px; border-radius:10px; font-weight:700; }
  .btn{ padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:1px solid #2a2a33; text-transform:uppercase; background:#1d1d22; color:#fff; }
  .btn.primary{ background:var(--gold); color:#141417; border-color:#000; }
  .pillCircle{ width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid #2a2a33; background:#1a1a20; color:#ddd; font-weight:800; cursor:pointer; transition:all .2s }
  .pillCircle.active{ background:var(--gold); color:#000; border-color:#000; }
  .accentLabel{ text-align:center; margin-top:2px; color:var(--muted); font-size:12px; }
  .accents{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:2px; }
  .accentBtn{ width:38px; height:38px; border-radius:10px; border:1px solid #2a2a33; background:#1a1a20; color:#ddd; font-weight:800; cursor:pointer }
  .accentBtn.on{ background:var(--gold); color:#141417; border-color:#000 }
  /* In-flow trainer panel: expands beneath button and pushes content down */
  .trainerWrap{ width:100%; display:flex; justify-content:center; }
  .trainerPanel{ width:min(620px,96%); background:var(--panel); border:1px solid #2a2a33; border-radius:12px; padding:12px; margin-top:8px;
                 overflow:hidden; max-height:0; opacity:0; transform:translateY(-6px); transition:max-height .25s ease, opacity .22s ease, transform .22s ease; }
  .trainerPanel.open{ max-height:400px; opacity:1; transform:translateY(0); }
  .trainer-help{ max-width:720px; width:min(100%,720px); margin:2px auto 8px; font-size:15px; line-height:1.45; color:var(--muted); }
  .kv{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }
  .kv input[type="number"]{ width:90px; background:#111; border:1px solid #2a2a33; color:#fff; padding:7px 9px; border-radius:10px; font-weight:700; text-align:center; }
  /* Footer (no overlap; page can scroll naturally if needed) */
  .linkbar{ margin-top:16px; border-top:1px solid #222; padding:10px; display:flex; justify-content:center; gap:20px; background:#0f0f12; }
  .linkbar a{ color:var(--gold); font-weight:800; text-decoration:none; font-size:clamp(13px,2vw,16px); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <img class="logo" src="assets/Frojax-Logo2024.png" alt="Frojax" />
        <h1 class="title-text">FROJAX FREE CLICK</h1>
        
      </div>

      <div class="indicatorRow">
        <div class="pulse" id="pulse">
          <div class="pulseCore"></div>
          <div class="pulseRing" id="pulseRing"></div>
        </div>
        <div class="bpmBig">
          <div id="bpmValue" class="bpmValue">120</div>
          <div class="bpmUnit">BPM</div>
          <div id="tsInline" class="tsInline">4/4</div>
        </div>
      </div>

      <div class="controls">
        <div class="row">
          <label for="bpm">Tempo</label>
          <input id="bpm" type="range" min="30" max="240" value="120" />
          <label for="volume">Volumen</label>
          <input id="volume" type="range" min="0" max="100" value="85" />
          <label for="soundType">Sonido</label>
          <select id="soundType" class="select" aria-label="Tipo de sonido">
            <option value="click" selected>Click</option>
            <option value="beep">Beep</option>
            <option value="tick">Tick</option>
            <option value="cowbell">Cowbell</option>
          </select>
        </div>

        <div class="row">
          <div class="pillCircle" data-bpm="60">60</div>
          <div class="pillCircle" data-bpm="80">80</div>
          <div class="pillCircle" data-bpm="100">100</div>
          <div class="pillCircle" data-bpm="125">125</div>
          <div class="pillCircle" data-bpm="150">150</div>
          <div class="pillCircle" data-bpm="175">175</div>
          <div class="pillCircle" data-bpm="200">200</div>
        </div>

        <div class="row">
          <button id="startStop" class="btn primary">Iniciar</button>
          <button id="trainerToggle" class="btn" aria-expanded="false" aria-controls="trainerPanel">Modo Entrenamiento: OFF</button>
        </div>

        <!-- In-flow trainer: appears here and pushes content down -->
        <div class="trainerWrap">
          <div id="trainerPanel" class="trainerPanel" role="region" aria-label="Opciones de entrenamiento">
            <div class="trainer-help">Práctica guiada que empieza en una velocidad y termina en otra, para una práctica enfocada en acondicionamiento y metas.</div>
            <div class="kv" role="group" aria-label="Parámetros de entrenamiento">
              <label for="startBpm">Inicio</label>
              <input id="startBpm" type="number" min="30" max="240" value="80" />
              <label for="endBpm">Final</label>
              <input id="endBpm" type="number" min="30" max="240" value="140" />
              <label for="durationMin">Duración (min)</label>
              <input id="durationMin" type="number" min="1" max="60" value="2" />
            </div>
          </div>
        </div>

        <!-- Compás y acentos -->
        <div class="row" style="flex-direction:column;margin-top:6px;">
          <div class="accentLabel">Beats/Compás (Numerador)</div>
          <div class="row">
            <button id="beatsMinus" class="btn" aria-label="Disminuir beats">−</button>
            <span id="beatsCount" class="btn">4</span>
            <button id="beatsPlus" class="btn" aria-label="Aumentar beats">＋</button>
          </div>

          <div class="accentLabel" style="margin-top:8px;">Unidad del Tiempo (Denominador)</div>
          <div class="row">
            <button id="denMinus" class="btn" aria-label="Disminuir denominador">−</button>
            <span id="denValue" class="btn">4</span>
            <button id="denPlus" class="btn" aria-label="Aumentar denominador">＋</button>
          </div>
        </div>

        <div class="row" style="flex-direction:column;margin-top:6px;">
          <div class="accentLabel">Acentos</div>
          <div id="accents" class="accents" aria-label="Acentos del compás"></div>
        </div>

      </div>

      <div class="linkbar">
        <a href="https://www.instagram.com/frojax" target="_blank" rel="noopener">INSTAGRAM</a>
        <a href="https://www.frojax.com/lecciones-y-clinicas" target="_blank" rel="noopener">LECCIONES Y CLÍNICAS</a>
        <a href="https://www.frojax.com" target="_blank" rel="noopener">FROJAX.COM</a>
      </div>
    </div>
  </div>

<script>
let audioCtx, masterGain;
let nextNoteTime = 0.0;
let currentBeat = 0;
let lookahead = 25;
let scheduleAheadTime = 0.10;
let timerID;
let isRunning = false;

// Time & accents
let bpm = 120;
let tsNumerator = 4;
let tsDenominator = 4;
let accents = [true, false, false, false];

// Trainer state
let trainerOn = false;
let trainerStartTS = null;

// UI refs
const bpmSlider = document.getElementById('bpm');
const bpmValue  = document.getElementById('bpmValue');
const startStop = document.getElementById('startStop');
const trainerToggle = document.getElementById('trainerToggle');
const trainerPanel  = document.getElementById('trainerPanel');
const volumeSlider = document.getElementById('volume');

const beatsMinus = document.getElementById('beatsMinus');
const beatsPlus  = document.getElementById('beatsPlus');
const beatsCount = document.getElementById('beatsCount');

const denMinus = document.getElementById('denMinus');
const denPlus  = document.getElementById('denPlus');
const denValue = document.getElementById('denValue');
const tsInline = document.getElementById('tsInline');
const accentsWrap= document.getElementById('accents');

const startBpmEl  = document.getElementById('startBpm');
const endBpmEl    = document.getElementById('endBpm');
const durationMinEl  = document.getElementById('durationMin');

const soundTypeSel = document.getElementById('soundType');
const pulse = document.getElementById('pulse');
const pulseRing = document.getElementById('pulseRing');

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = (Number(volumeSlider.value)||85) / 100;
    masterGain.connect(audioCtx.destination);
  }
}
function updateShortcutStates(){
  const val = Number(bpm);
  document.querySelectorAll('.pillCircle').forEach(btn=>{
    const target = Number(btn.getAttribute('data-bpm'));
    btn.classList.toggle('active', target === val);
  });
}
function setBpm(val){
  bpm = Math.max(30, Math.min(240, Math.round(val)));
  bpmSlider.value = bpm;
  bpmValue.textContent = bpm;
  updateShortcutStates();
}
function renderAccents(){
  accentsWrap.innerHTML = "";
  for(let i=0;i<tsNumerator;i++){
    const b = document.createElement('button');
    b.className = 'accentBtn' + (accents[i] ? ' on' : '');
    b.textContent = (i+1);
    b.setAttribute('aria-pressed', accents[i] ? 'true':'false');
    b.addEventListener('click', ()=>{
      accents[i] = !accents[i];
      renderAccents();
    });
    accentsWrap.appendChild(b);
  }
  beatsCount.textContent = String(tsNumerator);
  denValue.textContent = String(tsDenominator);
  tsInline.textContent = tsNumerator + "/" + tsDenominator;
}
function setNumerator(n){
  tsNumerator = Math.max(1, Math.min(12, n));
  const next = new Array(tsNumerator).fill(false);
  for(let i=0;i<Math.min(accents.length, tsNumerator); i++){ next[i] = accents[i]; }
  if(!next.some(Boolean)) next[0] = true;
  accents = next; currentBeat = 0; renderAccents();
}
function setDenominator(d){
  const steps = [1,2,4,8,16];
  if(!steps.includes(d)){ d = steps.reduce((p,c)=> Math.abs(c-d)<Math.abs(p-d)?c:p, 4); }
  tsDenominator = d; renderAccents();
}
function secondsPerBeat(){ return (60.0 / bpm) * (4.0 / tsDenominator); }
function playClick(time, isAccent){
  const type = soundTypeSel.value;
  let dur = 0.05;
  if(type === 'cowbell'){
    let osc1 = audioCtx.createOscillator();
    let osc2 = audioCtx.createOscillator();
    let mix = audioCtx.createGain();
    let gain = audioCtx.createGain();
    const f1 = isAccent ? 880 : 780;
    const f2 = isAccent ? 540 : 480;
    osc1.type = 'square';   osc1.frequency.setValueAtTime(f1, time);
    osc2.type = 'triangle'; osc2.frequency.setValueAtTime(f2, time);
    gain.gain.setValueAtTime(0.001, time);
    gain.gain.exponentialRampToValueAtTime(isAccent?0.9:0.6, time + 0.003);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.10);
    osc1.connect(mix); osc2.connect(mix); mix.connect(gain).connect(masterGain);
    osc1.start(time); osc2.start(time); osc1.stop(time + 0.12); osc2.stop(time + 0.12);
    visual(isAccent, time); return;
  }
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  let freq = 1300, oscType='square';
  if(type==='click'){freq=isAccent?2000:1300;oscType='square';dur=0.05;}
  if(type==='beep'){ freq=isAccent?1200:900; oscType='sine';  dur=0.06;}
  if(type==='tick'){ freq=isAccent?1600:1000;oscType='square';dur=0.03;}
  osc.type = oscType; osc.frequency.setValueAtTime(freq, time);
  gain.gain.setValueAtTime(0.001, time);
  gain.gain.exponentialRampToValueAtTime(isAccent?0.9:0.6, time + 0.002);
  gain.gain.exponentialRampToValueAtTime(0.0001, time + dur);
  osc.connect(gain).connect(masterGain); osc.start(time); osc.stop(time + dur);
  visual(isAccent, time);
}
function visual(isAccent, time){
  setTimeout(()=>{
    pulse.classList.add('glow');
    pulseRing.classList.remove('ringAnim'); void pulseRing.offsetWidth; pulseRing.classList.add('ringAnim');
    setTimeout(()=>{ pulse.classList.remove('glow'); }, 140);
  }, Math.max(0, (time - audioCtx.currentTime) * 1000));
}
function scheduleNote(beatNumber, time){
  const isAccent = accents[beatNumber % tsNumerator] === true;
  playClick(time, isAccent);
}
function nextNote(){ nextNoteTime += secondsPerBeat(); currentBeat = (currentBeat + 1) % tsNumerator; }
function scheduler(){
  while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime){
    scheduleNote(currentBeat, nextNoteTime); nextNote();
  }
  timerID = setTimeout(scheduler, lookahead);
}
function start(){
  initAudio(); audioCtx.resume();
  if(isRunning) return; isRunning = TrueFalse(true);
  startStop.textContent = 'Detener';
  nextNoteTime = audioCtx.currentTime + 0.05; currentBeat = 0;
  if(trainerOn){ trainerStartTS = null; }
  scheduler();
}
function stop(){ isRunning = false; startStop.textContent = 'Iniciar'; clearTimeout(timerID); }
function TrueFalse(v){ return v; }

bpmSlider.addEventListener('input', e => setBpm(e.target.value));
document.querySelectorAll('.pillCircle').forEach(btn=>{
  btn.addEventListener('click', ()=> setBpm(Number(btn.getAttribute('data-bpm'))));
});
updateShortcutStates();
startStop.addEventListener('click', ()=> isRunning ? stop() : start());
volumeSlider.addEventListener('input', e => { initAudio(); masterGain.gain.value = (Number(e.target.value)||0)/100; });

beatsMinus.addEventListener('click', ()=> setNumerator(tsNumerator-1));
beatsPlus .addEventListener('click', ()=> setNumerator(tsNumerator+1));
denMinus  .addEventListener('click', ()=> { const s=[1,2,4,8,16]; let i=s.indexOf(tsDenominator); if(i>0) setDenominator(s[i-1]); });
denPlus   .addEventListener('click', ()=> { const s=[1,2,4,8,16]; let i=s.indexOf(tsDenominator); if(i<s.length-1) setDenominator(s[i+1]); });

// Trainer toggle = in-flow expand/collapse, does NOT start audio
trainerToggle.addEventListener('click', ()=>{
  trainerOn = !trainerOn;
  trainerToggle.textContent = trainerOn ? 'Modo Entrenamiento: ON' : 'Modo Entrenamiento: OFF';
  trainerToggle.setAttribute('aria-expanded', String(trainerOn));
  trainerPanel.classList.toggle('open', trainerOn);
  trainerStartTS = null; // reset ramp state
});

// If parameters change while ON & running, restart ramp from Start BPM
[startBpmEl, endBpmEl, durationMinEl].forEach(el => {
  el.addEventListener('input', ()=>{
    if(trainerOn && isRunning && audioCtx){ trainerStartTS = null; }
  });
});

// Animation loop: apply ramp ONLY when trainerOn && running; panel is in flow so page shifts naturally
function animate(){
  if(trainerOn && isRunning && audioCtx){
    if(trainerStartTS === null){
      trainerStartTS = audioCtx.currentTime;
      setBpm(Number(startBpmEl.value)||80);
    }
    const mins = Math.max(1, Math.min(60, Number(durationMinEl.value)||2));
    const duration = mins * 60;
    const t = Math.min(1, (audioCtx.currentTime - trainerStartTS) / duration);
    const startB = Number(startBpmEl.value)||80;
    const endB   = Number(endBpmEl.value)||140;
    const cur = startB + (endB - startB) * t;
    setBpm(cur);
    if(t >= 1){ trainerOn = false; trainerPanel.classList.remove('open'); trainerToggle.textContent = 'Modo Entrenamiento: OFF'; trainerToggle.setAttribute('aria-expanded','false'); trainerStartTS=null; }
  } else { trainerStartTS = null; }
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// Initialize
setBpm(120); setNumerator(4); setDenominator(4);
// Unlock Audio on first user gesture
['touchstart','mousedown','keydown'].forEach(evt=>{
  window.addEventListener(evt, ()=>{ if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume(); } }, {passive:true});
});
</script>
</body>
</html>